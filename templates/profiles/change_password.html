{% extends 'base.html' %}
{% load static tailwind_tags %}
{% block content %}

<body class="bg-gradient animate-gradient">
  <div class="container my-4 px-4">
    <div class="flex flex-col md:flex-row">
      <div class="md:w-3/5 mx-2 mt-8 text-blue-950">
        <h5 class="text-3xl font-bold mb-1">Su contraseña...</h5>
        <ul class="list-disc list-inside text-2xl">
          <li id="lengthCheck" class="text-md text-blue-950 font-sans font-bold">✕ Debe contener por lo menos 12 caracteres</li>
          <li id="uppercaseCheck" class="text-md text-blue-950 font-sans font-bold ">✕ Al menos una letra mayúscula</li>
          <li id="lowercaseCheck" class="text-md text-blue-950 font-sans font-bold ">✕ Al menos una letra minúscula</li>
          <li id="specialCharCheck" class="text-md text-blue-950 font-sans font-bold ">✕ Al menos un carácter especial</li>
          <li id="numericCheck" class="text-md text-blue-950 font-sans font-bold">✕ Al menos un número</li>
          <li id="commonPasswordCheck" class="text-md text-blue-950 font-sans font-bold">✕ No puede ser una contraseña usada muy comúnmente</li>
        </ul>
      </div>

      <div class="overflow-hidden md:w-2/3 flex items-center mt-12">
        <div class="w-full md:w-4/5 lg:w-3/5 xl:w-2/3 shadow-3xl rounded-xl">
          <div class="absolute left-1/2 transform -translate-x-1/2 -translate-y-1/3 rounded-full"></div>
          <form id="passwordForm" action="{% url 'profile_password_change' %}" method="post" 
                class="p-6 md:p-6 bg-gradient-to-b from-blue-950 to-blue-900">
            <img class="mx-auto w-16 h-16 rounded-full mb-3" src="{{ user.profile.image.url }}" alt="{{ user.username }}">
            <h2 class="text-white text-2xl font-sans font-semibold mb-4">Cambiar Contraseña</h2>
            {% csrf_token %}

            <h2 class="text-white text-md italic mb-0">Ingrese Contraseña Actual</h2>
            <div class="flex flex-col space-y-2">
              <div class="flex items-center text-lg mb-2">
                <svg class="absolute ml-3" viewBox="0 0 24 24" width="24">
                  <path d="m18.75 9h-.75v-3c0-3.309-2.691-6-6-6s-6 2.691-6 6v3h-.75c-1.24 0-2.25 1.009-2.25 2.25v10.5c0 1.241 1.01 2.25 2.25 2.25h13.5c1.24 0 2.25-1.009 2.25-2.25v-10.5c0-1.241-1.01-2.25-2.25-2.25zm-10.75-3c0-2.206 1.794-4 4-4s4 1.794 4 4v3h-8zm5 10.722v2.278c0 .552-.447 1-1 1s-1-.448-1-1v-2.278c-.595-.347-1-.985-1-1.722 0-1.103.897-2 2-2s2 .897 2 2c0 .737-.405 1.375-1 1.722z"/>
                </svg>
                <input type="password" name="old_password" id="old_password" 
                       class="bg-gray-200 rounded-xl pl-10 py-1 md:py-2 text-sm focus:outline-none w-full" 
                       placeholder="Contraseña actual" />
              </div>
              <span id="oldPasswordError" class="text-red-500 text-sm hidden"></span>
            </div>

            <h2 class="text-white text-md font-sans italic mb-0">Ingrese Nueva Contraseña</h2>
            <div class="flex flex-col space-y-2">
              <div class="flex items-center text-lg mb-2">
                <svg class="absolute ml-3" viewBox="0 0 24 24" width="24">
                  <path d="m18.75 9h-.75v-3c0-3.309-2.691-6-6-6s-6 2.691-6 6v3h-.75c-1.24 0-2.25 1.009-2.25 2.25v10.5c0 1.241 1.01 2.25 2.25 2.25h13.5c1.24 0 2.25-1.009 2.25-2.25v-10.5c0-1.241-1.01-2.25-2.25-2.25zm-10.75-3c0-2.206 1.794-4 4-4s4 1.794 4 4v3h-8zm5 10.722v2.278c0 .552-.447 1-1 1s-1-.448-1-1v-2.278c-.595-.347-1-.985-1-1.722 0-1.103.897-2 2-2s2 .897 2 2c0 .737-.405 1.375-1 1.722z"/>
                </svg>
                <input type="password" name="new_password1" id="new_password1" 
                       class="form-control bg-gray-200 rounded-xl pl-10 py-1 md:py-2 text-sm focus:outline-none w-full" 
                       placeholder="Nueva Contraseña" />
              </div>
            </div>

            <h2 class="text-white text-dm font-sans italic mb-0">Reingrese Nueva Contraseña</h2>
            <div class="flex flex-col space-y-2">
              <div class="flex items-center text-lg mb-2">
                <svg class="absolute ml-3" viewBox="0 0 24 24" width="24">
                  <path d="m18.75 9h-.75v-3c0-3.309-2.691-6-6-6s-6 2.691-6 6v3h-.75c-1.24 0-2.25 1.009-2.25 2.25v10.5c0 1.241 1.01 2.25 2.25 2.25h13.5c1.24 0 2.25-1.009 2.25-2.25v-10.5c0-1.241-1.01-2.25-2.25-2.25zm-10.75-3c0-2.206 1.794-4 4-4s4 1.794 4 4v3h-8zm5 10.722v2.278c0 .552-.447 1-1 1s-1-.448-1-1v-2.278c-.595-.347-1-.985-1-1.722 0-1.103.897-2 2-2s2 .897 2 2c0 .737-.405 1.375-1 1.722z"/>
                </svg>
                <input type="password" name="new_password2" id="new_password2" 
                       class="form-control bg-gray-200 rounded-xl pl-10 py-1 md:py-2 text-sm focus:outline-none w-full" 
                       placeholder="Confirme Nueva Contraseña" />
              </div>
              <span id="passwordMatchError" class="text-red-500 text-sm hidden">✕ Las contraseñas no coinciden</span>
            </div>  

            <!-- Modal Footer -->
            <div class="modal-footer flex flex-col justify-end mt-8 w-full">
              <button type="submit" id="submitBtn" class="bg-gradient-to-b from-amber-200 via-amber-300 to-amber-300 
              hover:from-amber-600 hover:to-amber-500 text-blue-900 px-2 py-2 font-semibold uppercase w-full rounded-full mx-auto mb-2" disabled>GUARDAR NUEVA CONTRASEÑA</button>

              <a href="{% url 'profile' %}"
                class="bg-gradient-to-b from-blue-400 via-blue-500 to-blue-400 
                hover:from-blue-600 hover:to-blue-500 text-white text-center font-semibold mt-2 py-2 px-4 rounded-full block w-full">REGRESAR A PERFILES</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const newPassword1 = document.getElementById('new_password1');
      const newPassword2 = document.getElementById('new_password2');
      const submitBtn = document.getElementById('submitBtn');

      const lengthCheck = document.getElementById('lengthCheck');
      const uppercaseCheck = document.getElementById('uppercaseCheck');
      const lowercaseCheck = document.getElementById('lowercaseCheck');
      const specialCharCheck = document.getElementById('specialCharCheck');
      const commonPasswordCheck = document.getElementById('commonPasswordCheck');
      const numericCheck = document.getElementById('numericCheck');
      const passwordMatchError = document.getElementById('passwordMatchError');

      const commonPasswords = ["123456", "password", "123456789", "12345678", "12345", "1234567", "1234567890", "qwerty", "abc123", "password1"];

      function validatePassword() {
        const password = newPassword1.value;
        let valid = true;

        // Verificar si la longitud de la contraseña es de al menos 12 caracteres
        if (password.length >= 12) {
          lengthCheck.classList.remove('text-red-500');
          lengthCheck.classList.add('text-green-500');
          lengthCheck.textContent = '✓ Debe contener por lo menos 12 caracteres';
        } else {
          lengthCheck.classList.remove('text-green-500');
          lengthCheck.classList.add('text-red-500');
          lengthCheck.textContent = '✕ Debe contener por lo menos 12 caracteres';
          valid = false;
        }

        // Verificar si la contraseña contiene al menos una letra mayúscula
        if (/[A-Z]/.test(password)) {
          uppercaseCheck.classList.remove('text-red-500');
          uppercaseCheck.classList.add('text-green-500');
          uppercaseCheck.textContent = '✓ Al menos una letra mayúscula';
        } else {
          uppercaseCheck.classList.remove('text-green-500');
          uppercaseCheck.classList.add('text-red-500');
          uppercaseCheck.textContent = '✕ Al menos una letra mayúscula';
          valid = false;
        }

        // Verificar si la contraseña contiene al menos una letra minúscula
        if (/[a-z]/.test(password)) {
          lowercaseCheck.classList.remove('text-red-500');
          lowercaseCheck.classList.add('text-green-500');
          lowercaseCheck.textContent = '✓ Al menos una letra minúscula';
        } else {
          lowercaseCheck.classList.remove('text-green-500');
          lowercaseCheck.classList.add('text-red-500');
          lowercaseCheck.textContent = '✕ Al menos una letra minúscula';
          valid = false;
        }

        // Verificar si la contraseña contiene al menos un carácter especial
        if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
          specialCharCheck.classList.remove('text-red-500');
          specialCharCheck.classList.add('text-green-500');
          specialCharCheck.textContent = '✓ Al menos un carácter especial';
        } else {
          specialCharCheck.classList.remove('text-green-500');
          specialCharCheck.classList.add('text-red-500');
          specialCharCheck.textContent = '✕ Al menos un carácter especial';
          valid = false;
        }

        // Verificar si la contraseña no es una contraseña usada muy comúnmente
        if (!commonPasswords.includes(password)) {
          commonPasswordCheck.classList.remove('text-red-500');
          commonPasswordCheck.classList.add('text-green-500');
          commonPasswordCheck.textContent = '✓ No puede ser una contraseña usada muy comúnmente';
        } else {
          commonPasswordCheck.classList.remove('text-green-500');
          commonPasswordCheck.classList.add('text-red-500');
          commonPasswordCheck.textContent = '✕ No puede ser una contraseña usada muy comúnmente';
          valid = false;
        }

        // Verificar si la contraseña no está formada exclusivamente por números
        if (!/^\d+$/.test(password)) {
          numericCheck.classList.remove('text-red-500');
          numericCheck.classList.add('text-green-500');
          numericCheck.textContent = '✓ No puede estar formada exclusivamente por números';
        } else {
          numericCheck.classList.remove('text-green-500');
          numericCheck.classList.add('text-red-500');
          numericCheck.textContent = '✕ No puede estar formada exclusivamente por números';
          valid = false;
        }

        // Verificar si la contraseña contiene al menos un número
        if (/\d/.test(password)) {
          numericCheck.classList.remove('text-red-500');
          numericCheck.classList.add('text-green-500');
          numericCheck.textContent = '✓ Debe contener al menos un número';
        } else {
          numericCheck.classList.remove('text-green-500');
          numericCheck.classList.add('text-red-500');
          numericCheck.textContent = '✕ Debe contener al menos un número';
          valid = false;
        }

        // Verificar si ambas contraseñas coinciden
        if (newPassword1.value === newPassword2.value) {
          passwordMatchError.classList.add('hidden');
        } else {
          passwordMatchError.classList.remove('hidden');
          valid = false;
        }

        // Habilitar o deshabilitar el botón de envío basado en la validación
        submitBtn.disabled = !valid;
      }

      // Agregar event listeners para validar las contraseñas en cada entrada
      newPassword1.addEventListener('input', validatePassword);
      newPassword2.addEventListener('input', validatePassword);
    });
  </script>
</body>
{% endblock %}